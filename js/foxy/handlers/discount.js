// js/foxy/handlers/discount.js
import { addTypingMessage } from "../ui/dom.js";

function genCode() {
  return "FOX-" + Math.random().toString(36).substr(2, 4).toUpperCase();
}

export function handleDiscount() {
  const now = Date.now();
  const savedCode = localStorage.getItem("promoCode");
  const expires = parseInt(localStorage.getItem("promoExpires"), 10);
  const used = localStorage.getItem("promoUsed") === "true";

  // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ —É–∂–µ –µ—Å—Ç—å
  if (savedCode && expires && now < expires && !used) {
    const deadline = new Date(expires).toLocaleDateString();
    addTypingMessage(
      `üéÅ –£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥: <strong>${savedCode}</strong><br><small>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ ${deadline}</small>`,
      300,
      true
    );
    return;
  }

  // –ù–æ–≤—ã–π –∫–æ–¥
  const code = genCode();
  const duration = 7 * 24 * 60 * 60 * 1000;
  const expireTime = now + duration;
  const deadline = new Date(expireTime).toLocaleDateString();

  localStorage.setItem("promoCode", code);
  localStorage.setItem("promoExpires", expireTime.toString());
  localStorage.setItem("promoUsed", "false");

  addTypingMessage(
    `üéâ –¢–≤–æ–π –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: <strong>${code}</strong><br><small>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ ${deadline}<br>üìã –ü–æ–∫–∞–∂–∏ –º–∞—Å—Ç–µ—Ä—É –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ ‚Äî –ø–æ–ª—É—á–∏—à—å –ø–æ–¥–∞—Ä–æ–∫ –∏–ª–∏ —Å–∫–∏–¥–∫—É!</small>`,
    500,
    true
  );
}

export function remindPromoIfActive() {
  const code = localStorage.getItem("promoCode");
  const expires = parseInt(localStorage.getItem("promoExpires"), 10);
  const used = localStorage.getItem("promoUsed") === "true";
  const now = Date.now();

  if (code && expires && now < expires && !used) {
    const deadline = new Date(expires).toLocaleDateString();
    addTypingMessage(
      `üí° –ù–µ –∑–∞–±—É–¥—å ‚Äî —É —Ç–µ–±—è –µ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥: <strong>${code}</strong><br><small>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ ${deadline}</small>`,
      400,
      true
    );
  }
}

export function markPromoUsed() {
  localStorage.setItem("promoUsed", "true");
}
