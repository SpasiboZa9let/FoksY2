import { matchIntent } from "../core/intents.js";
import { matchService, emoji, services, randomReply } from "../core/services.js";
import {
  lastInput, setLastInput, setLastIntent,
  setLastService, lastService
} from "../core/state.js";

import { addMessage, clearButtons } from "../ui/dom.js";
import { renderBookingOptions, renderServiceList } from "../ui/ui.js";

import { handleDesign } from "./design.js";
import { handleMood } from "./mood.js";
import { handleSmalltalk } from "./smalltalk.js";
import { handleServiceInput } from "./servicesHandler.js";

export function handleUserInput(message) {
  clearButtons();

  const input = message.trim().toLowerCase();
  if (!input || input === lastInput) return;
  setLastInput(input);

  addMessage(`–í—ã: ${message}`);

  // üí¨ –£—Ç–æ—á–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã, –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
  if (/—Å–∫–æ–ª—å–∫–æ.*—Å—Ç–æ–∏—Ç|—Ü–µ–Ω–∞|–ø–æ–¥—Ä–æ–±–Ω|—É–∑–Ω–∞|—ç—Ç–æ —Å|–º–æ–∂–Ω–æ|–∞ –≥–¥–µ|–∞ –∫–æ–≥–¥–∞|–ø–æ–¥–æ–π–¥–µ—Ç/i.test(input)) {
    if (lastService && services[lastService]) {
      addMessage(`${emoji()} –ê–≥–∞, —ç—Ç–æ ¬´${lastService}¬ª üíÖ\n${services[lastService]}`);
      renderBookingOptions();
      return;
    }
  }

  // üîç –ü–æ–∏—Å–∫ –ø–æ —Å–∏–Ω–æ–Ω–∏–º–∞–º —É—Å–ª—É–≥
  const svc = matchService(input);
  if (svc) {
    setLastService(svc.name);
    setLastIntent("service");
    handleServiceInput(svc.name);
    return;
  }

  // ü§ñ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Ç–∞
  const intent = matchIntent(input);
  setLastIntent(intent);

  // üéØ –†–æ—É—Ç–∏–Ω–≥
  switch (intent) {
    case "design":
      handleDesign();
      break;

    case "mood":
      handleMood();
      break;

    case "showServices":
      renderServiceList();
      break;

    case "booking":
      renderBookingOptions();
      break;

    default:
      if (!handleSmalltalk(intent)) {
        addMessage(`${emoji()} ${randomReply(intent)}`, true);
        setTimeout(() => renderServiceList(), 800); // –Ω–µ —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ –¥—É—à–∏–ª–∞
      }
  }
}
