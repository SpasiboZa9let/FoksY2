import { matchIntent } from "../core/intents.js";
import { matchService, emoji, services, randomReply } from "../core/services.js";
import {
  lastInput, setLastInput, lastIntent, setLastIntent,
  lastService, setLastService,
  userName, setUserName
} from "../core/state.js";

import { addMessage, clearButtons } from "../ui/dom.js";
import { renderBookingOptions, renderServiceList } from "../ui/ui.js";

import { handleDesign } from "./design.js";
import { handleMood } from "./mood.js";
import { handleSmalltalk } from "./smalltalk.js";
import { handleServiceInput, showServiceDetails } from "./servicesHandler.js";

// –í–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π (–≤ core/state –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
const greetings = [
  `–ü—Ä–∏–≤–µ—Ç, %NAME%! üíñ –ß–µ–º —Å–µ–≥–æ–¥–Ω—è –ø–æ—Ä–∞–¥–æ–≤–∞—Ç—å —Ç–≤–æ–∏ –Ω–æ–≥–æ—Ç–∫–∏?`,
  `–°–∞–ª—é—Ç, %NAME%! üåü –ì–æ—Ç–æ–≤–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫—Ä–∞—Å–æ—Ç—É –≤–º–µ—Å—Ç–µ?`,
  `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, %NAME%! ‚ú® –ß—Ç–æ –≤—ã–±–µ—Ä–µ–º –¥–ª—è —Ç–≤–æ–µ–≥–æ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –º–∞–Ω–∏–∫—é—Ä–∞?`,
  `–•—ç–π, %NAME%! üíÖ –ì–æ—Ç–æ–≤–∞ –∫ —Å—Ç–∏–ª—å–Ω–æ–º—É –ø—Ä–µ–æ–±—Ä–∞–∂–µ–Ω–∏—é?`,
  `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, %NAME%! üòä –î–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º –Ω–æ–≥–æ—Ç–∫–∏ –æ—Å–æ–±–µ–Ω–Ω—ã–º–∏!`
];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–º–µ–Ω–∏
function randomGreeting(name) {
  const tpl = greetings[Math.floor(Math.random() * greetings.length)];
  return tpl.replace("%NAME%", name);
}

// –ï–¥–∏–Ω—ã–π –±–ª–æ–∫ –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫
function showSuggestions() {
  addMessage(
    `<div class="foxy-suggestions">
       <div class="description">–í–æ—Ç —á—Ç–æ —è –º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:</div>
       <div class="buttons-wrapper">
         <button class="ai-btn" data-action="–ø—Ä–∞–π—Å">üíÖ –ó–∞–≥–ª—è–Ω—É—Ç—å –≤ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç</button>
         <button class="ai-btn" data-action="–¥–∏–∑–∞–π–Ω">üé® –í–¥–æ—Ö–Ω–æ–≤–∏—Ç—å—Å—è –∏–¥–µ—è–º–∏ –¥–∏–∑–∞–π–Ω–∞</button>
         <button class="ai-btn" data-action="–∑–∞–ø–∏—Å–∞—Ç—å—Å—è">üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è</button>
         <button class="ai-btn" data-action="—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å">‚ùì –£–∑–Ω–∞—Ç—å –≤—Å–µ –º–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</button>
       </div>
       <div class="footer">–í—ã–±–µ—Ä–∏, —á—Ç–æ —Ç–µ–±–µ –ø–æ –¥—É—à–µ, –∏ —è –≤—Å—ë –ø–æ–∫–∞–∂—É üíñ</div>
     </div>`,
    true
  );
}

// –≥–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞
export function handleUserInput(message) {
  clearButtons();

  // 1) –ï—Å–ª–∏ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª–∏ –∏–º—è ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
  if (lastIntent === 'askName') {
    const name = message.trim();
    setUserName(name);
    localStorage.setItem('foxy_userName', name);
    addMessage(`–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, ${name}! üíñ`, false);

    addMessage(
      `<strong>${emoji()} –§–æ–∫—Å–∏:</strong> ${randomGreeting(name)}`,
      true
    );
    showSuggestions();
    setLastIntent(null);
    return;
  }

  // 2) –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞
  const input = message.trim();
  if (!input || input.toLowerCase() === lastInput) return;
  const prevIntent = lastIntent; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ–Ω—Ç
  setLastInput(input.toLowerCase());

  addMessage(`–í—ã: ${message}`);

  // ü§ñ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–Ω—Ç–µ–Ω—Ç–∞
  const intent = matchIntent(input);
  setLastIntent(intent);

  // üö¶ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏
  if (intent === 'confirm' && prevIntent === 'service') {
    showServiceDetails(lastService);
    return;
  }

  // ü¶ä Smalltalk
  if (handleSmalltalk(intent)) return;

  // üóÇ –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ª—É–≥–∏ –∏–ª–∏ ¬´–ø–æ–∫–∞–∂–∏¬ª
  if (intent === "showSomething" || intent === "showServices") {
    const svc2 = matchService(input);
    if (svc2) {
      setLastService(svc2.name);
      setLastIntent("service");
      handleServiceInput(svc2.name);
    } else {
      renderServiceList();
    }
    return;
  }

  // üìù –£—Ç–æ—á–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã/–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
  const inquireRe = /(—Å–∫–æ–ª—å–∫–æ|—Å–∫–æ–ª–∫[–æ—å—è]|—Å—Ç–æ–∏–º–æ—Å—Ç|—Ü–µ–Ω–∞)/i;
  if (inquireRe.test(input)) {
    const svc2 = matchService(input);
    if (svc2) setLastService(svc2.name);

    if (lastService && services[lastService]) {
      addMessage(`${emoji()} ${randomReply("inquireDetails")}`, true);
      addMessage(`¬´${lastService}¬ª üíÖ\n${services[lastService]}`);
      renderBookingOptions();
    } else {
      addMessage(randomReply("fallback"));
      renderServiceList();
    }
    return;
  }

  // üîç –ü–æ–ø—ã—Ç–∫–∞ —É–≥–∞–¥–∞—Ç—å —É—Å–ª—É–≥—É
  const svc = matchService(input);
  if (svc) {
    setLastService(svc.name);
    setLastIntent("service");
    handleServiceInput(svc.name);
    return;
  }

  // üéØ –û—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã
  switch (intent) {
    case "design":
      handleDesign();
      break;
    case "mood":
      handleMood();
      break;
    case "booking":
    case "confirmBooking":
      renderBookingOptions();
      break;
    default:
      addMessage(randomReply("fallback"));
      renderServiceList();
  }
}
